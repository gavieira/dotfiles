#!/bin/bash

# Save current IFS
SAVEIFS=$IFS
# Change IFS to newline
IFS=$(echo -en "\n\b")

# Find all video files in current directory and subdirectories
video_files=$(find . -type f \( -name "*.mp4" -o -name "*.mkv" -o -name "*.avi" -o -name "*.mov" \))

# Iterate through each video file
for file in $video_files; do
    # Extract the subdirectory relative path
    subdirectory=$(dirname "$file")
    
    # Get the base name WITHOUT extension (correct way)
    base_name=$(basename "$file")
    base_name="${base_name%.*}"  # Remove everything after the last dot
    
    # Define the expected English SRT file name
    en_srt_file="${subdirectory}/${base_name}.en.srt"
    
    # Debug: show what we're looking for
    echo "Checking for: $en_srt_file"
    
    # Check if the English SRT file already exists
    if [ -e "$en_srt_file" ]; then
        echo "English SRT file already exists for $file. Skipping."
    else
        # Generate the SRT file using 'whisper' - this will create base_name.srt
        echo "Generating subtitles for: $file"
        whisper "$file" --output_format srt --model base.en --output_dir "$subdirectory"
        
        # Define the file that Whisper actually generated (without .en)
        generated_srt="${subdirectory}/${base_name}.srt"
        
        # Check if Whisper successfully generated the file
        if [ -e "$generated_srt" ]; then
            # Rename the generated file to include .en suffix
            mv "$generated_srt" "$en_srt_file"
            echo "Generated and renamed: $en_srt_file"
        else
            echo "Warning: No SRT file was generated for $file"
        fi
    fi
    echo "---"
done

# Restore IFS
IFS=$SAVEIFS


# Now, call the Python script to translate all .en.srt files to .pt.srt
echo "Starting translation of .en.srt files to Portuguese..."
python3 /home/gabriel/.config/nnn/plugins/translate_srt.py
